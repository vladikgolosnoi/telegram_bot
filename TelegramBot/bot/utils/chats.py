import random
import json
import pandas as pd
from fuzzywuzzy import fuzz  # –ò–º–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å—Ç—Ä–æ–∫
import g4f.Provider
from g4f.client import AsyncClient

from bot.utils.afisha import get_all_events

# –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–æ–≤
conversation_history = {}

# –ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏–∑ Excel
places_data = {}

# –ß—Ç–µ–Ω–∏–µ –≤—Å–µ—Ö –≤–∫–ª–∞–¥–æ–∫ –∏–∑ Excel-—Ñ–∞–π–ª–∞
try:
    sheets = pd.read_excel('data/places.xlsx', sheet_name=None)  # –£–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å –∫ –≤–∞—à–µ–º—É Excel-—Ñ–∞–π–ª—É
    for sheet_name, df in sheets.items():
        if not df.empty:
            df = df.rename(columns={
                "–ù–∞–∑–≤–∞–Ω–∏–µ": "–Ω–∞–∑–≤–∞–Ω–∏–µ",
                "–û–ø–∏—Å–∞–Ω–∏–µ": "–æ–ø–∏—Å–∞–Ω–∏–µ",
                "–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ": "–∞–¥—Ä–µ—Å",
                "–ö–∞—Ä—Ç–∞": "–∫–∞—Ä—Ç–∞",
                "–¢–µ–≥–∏": "—Ç–µ–≥–∏"
            }).fillna("")
            if "—Ç–µ–≥–∏" in df.columns:
                df["—Ç–µ–≥–∏"] = df["—Ç–µ–≥–∏"].apply(lambda x: x.split(",") if x else [])
            places_data[sheet_name.lower()] = df.to_dict(orient="records")
except FileNotFoundError:
    print("–§–∞–π–ª data/places.xlsx –Ω–µ –Ω–∞–π–¥–µ–Ω")


def get_all_categories_and_places():
    """
    –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ –≤—Å–µ—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏ –∏—Ö –¥–∞–Ω–Ω—ã—Ö.
    """
    if not places_data:
        return "–î–∞–Ω–Ω—ã–µ –æ –º–µ—Å—Ç–∞—Ö –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã."

    response = "–í–æ—Ç –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ –∏—Ö –¥–∞–Ω–Ω—ã–µ:\n"
    for category, places in places_data.items():
        response += f"\n–ö–∞—Ç–µ–≥–æ—Ä–∏—è: {category.capitalize()}\n"
        response += "-" * 30 + "\n"
        for i, place in enumerate(places, start=1):
            response += (
                f"{i}. {place.get('–Ω–∞–∑–≤–∞–Ω–∏–µ', '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}\n"
                f"–û–ø–∏—Å–∞–Ω–∏–µ: {place.get('–æ–ø–∏—Å–∞–Ω–∏–µ', '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç')}\n"
                f"–ê–¥—Ä–µ—Å: {place.get('–∞–¥—Ä–µ—Å', '–ê–¥—Ä–µ—Å –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç')}\n"
                f"–ö–∞—Ä—Ç–∞: {place.get('–∫–∞—Ä—Ç–∞', '–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ä—Ç—É –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç')}\n"
            )
            # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–≥–∏, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
            if "—Ç–µ–≥–∏" in place and place['—Ç–µ–≥–∏']:
                response += f"–¢–µ–≥–∏: {', '.join(place['—Ç–µ–≥–∏'])}\n"
            else:
                response += "–¢–µ–≥–∏: –ù–µ—Ç —Ç–µ–≥–æ–≤\n"
            response += "\n"  # –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –º–µ–∂–¥—É –º–µ—Å—Ç–∞–º–∏
    return response.strip()



def get_restaurants_by_tags(query_tags):
    """
    –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤ –ø–æ —Ç–µ–≥–∞–º, –≤–∫–ª—é—á–∞—è –ø–æ—Ö–æ–∂–∏–µ —Ç–µ–≥–∏.
    """
    results = []
    for place in places_data.get("—Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã", []):  # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—é "—Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã"
        for tag in query_tags:
            for place_tag in place['—Ç–µ–≥–∏']:
                similarity_score = fuzz.partial_ratio(tag.lower(), place_tag.lower())
                if similarity_score > 70:  # –£—Å–ª–æ–≤–∏–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –ø–æ —Ç–µ–≥—É
                    results.append(place)
                    break
    return results[:5]  # –õ–∏–º–∏—Ç–∏—Ä—É–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤


def get_random_places_from_category(category, count=3):
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª—É—á–∞–π–Ω—ã–µ –º–µ—Å—Ç–∞ –∏–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.
    """
    category = category.lower()
    if category in places_data and len(places_data[category]) > 0:
        chosen = random.sample(places_data[category], min(count, len(places_data[category])))
        response = f"–í–æ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–µ—Å—Ç –∏–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ '{category}':\n"
        for i, place in enumerate(chosen, start=1):
            response += (
                f"{i}. {place['–Ω–∞–∑–≤–∞–Ω–∏–µ']} - {place['–∞–¥—Ä–µ—Å']}\n"
                f"–û–ø–∏—Å–∞–Ω–∏–µ: {place['–æ–ø–∏—Å–∞–Ω–∏–µ']}\n\n"
            )
        return response.strip()
    return f"–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –Ω–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –º–µ—Å—Ç–∞ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ '{category}'."


def get_place_details(query=None):
    """
    –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø–æ –∑–∞–ø—Ä–æ—Å—É.
    –ò—â–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –º–µ—Å—Ç–∞.
    """
    if query:
        query_lower = query.lower()

        # –ü—Ä—è–º–æ–π –ø–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
        best_match = None
        best_score = 0

        for category, places in places_data.items():
            for place in places:
                place_name = place['–Ω–∞–∑–≤–∞–Ω–∏–µ'].lower()
                similarity_score = fuzz.partial_ratio(query_lower, place_name)
                if similarity_score > best_score:
                    best_score = similarity_score
                    best_match = place

                # –ï—Å–ª–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –≤—ã—Å–æ–∫–æ–µ, —Å—Ä–∞–∑—É –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –º–µ—Å—Ç–æ
                if similarity_score > 80:
                    return (
                        f"–í–æ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–µ—Å—Ç–µ '{place['–Ω–∞–∑–≤–∞–Ω–∏–µ']}':\n"
                        f"–û–ø–∏—Å–∞–Ω–∏–µ: {place['–æ–ø–∏—Å–∞–Ω–∏–µ']}\n"
                        f"–ê–¥—Ä–µ—Å: {place['–∞–¥—Ä–µ—Å']}\n"
                        f"–ö–∞—Ä—Ç–∞: {place['–∫–∞—Ä—Ç–∞']}"
                    )

        # –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–æ —Ö–æ—Ä–æ—à–µ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –µ–≥–æ
        if best_match and best_score > 60:
            return (
                f"–í–æ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–µ—Å—Ç–µ '{best_match['–Ω–∞–∑–≤–∞–Ω–∏–µ']}':\n"
                f"–û–ø–∏—Å–∞–Ω–∏–µ: {best_match['–æ–ø–∏—Å–∞–Ω–∏–µ']}\n"
                f"–ê–¥—Ä–µ—Å: {best_match['–∞–¥—Ä–µ—Å']}\n"
                f"–ö–∞—Ä—Ç–∞: {best_match['–∫–∞—Ä—Ç–∞']}"
            )

    # –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –ø—É—Å—Ç–æ–π –∏–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–ª—É—á–∞–π–Ω—É—é –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å
    random_category = random.choice(list(places_data.keys()))
    random_place = random.choice(places_data[random_category])
    return (
        f"–ù–∞–∑–≤–∞–Ω–∏–µ: {random_place['–Ω–∞–∑–≤–∞–Ω–∏–µ']}\n"
        f"–û–ø–∏—Å–∞–Ω–∏–µ: {random_place['–æ–ø–∏—Å–∞–Ω–∏–µ']}\n"
        f"–ê–¥—Ä–µ—Å: {random_place['–∞–¥—Ä–µ—Å']}\n"
        f"–ö–∞—Ä—Ç–∞: {random_place['–∫–∞—Ä—Ç–∞']}"
    )


def find_best_category(query):
    """–ù–∞—Ö–æ–¥–∏—Ç –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –ø–æ –∑–∞–ø—Ä–æ—Å—É —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º fuzzywuzzy."""
    query_lower = query.lower()
    best_match = None
    best_score = 0
    for cat in places_data.keys():
        similarity_score = fuzz.partial_ratio(query_lower, cat)
        if similarity_score > best_score:
            best_score = similarity_score
            best_match = cat
    if best_score > 70:  # –ü–æ—Ä–æ–≥ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
        return best_match
    return None


async def chat(user_name, user_input, clear=False):
    if clear and conversation_history.get(user_name):
        del conversation_history[user_name]

    client = AsyncClient(provider=g4f.Provider.ChatGptEs)

    try:
        events_text = get_all_events()

        if user_name not in conversation_history:
            conversation_history[user_name] = [
                {"role": "system", "content": (
                    "–¢—ã ‚Äî –ê–º–∞–ª–∏—è, —É–º–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –∏ –≥–æ—Ä–æ–¥—Å–∫–æ–π –≥–∏–¥ üåü. "
                    "–¢–≤–æ—è —Ü–µ–ª—å ‚Äî –ø–æ–º–æ–≥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏ –º–µ—Å—Ç, –º–∞—Ä—à—Ä—É—Ç–æ–≤ –∏ —Å–æ–±—ã—Ç–∏–π –≤ –†–æ—Å—Ç–æ–≤–µ-–Ω–∞-–î–æ–Ω—É. "
                    "–ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –∑–∞–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–π –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, –æ—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ –∏—Ö –∏–Ω—Ç–µ—Ä–µ—Å–∞—Ö –∏ –¥–∞–Ω–Ω—ã—Ö. "

                    f"–£ —Ç–µ–±—è —Ç–∞–∫–∂–µ –µ—Å—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ–±—ã—Ç–∏—è—Ö: {events_text}.\n"
                    "–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ —Å–æ–±—ã—Ç–∏—è—Ö, –ø—Ä–µ–¥–ª–∞–≥–∞–π —Ç–æ–ª—å–∫–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –∏–∑ —ç—Ç–æ–≥–æ —Å–ø–∏—Å–∫–∞(–µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∫–∞–∑—ã–≤–∞–µ—Ç –¥–∞—Ç—É —Ç–æ —Å–≤–µ—Ä—è–π –ø–æ –¥–∞—Ç–∞–º). –£–∫–∞–∑—ã–≤–∞–π, –∫–æ–≥–¥–∞ –æ–Ω–∏ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è, –¥–æ–±–∞–≤–ª—è–π –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –∏ —Å—Å—ã–ª–∫–∏ –Ω–∞ —Å–æ–±—ã—Ç–∏—è. "
                    "–ï—Å–ª–∏ –∏–¥–µ—Ç –¥–∏–∞–ª–æ–≥ –ø—Ä–æ –≥—Ä—è–¥—É—â–∏–µ —Å–æ–±—ã—Ç–∏—è –∏–ª–∏ –ø–æ—Ö–æ–∂–∏–µ."
                    "–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–¥–∞–µ—Ç –≤–æ–ø—Ä–æ—Å –æ —Å–æ–±—ã—Ç–∏–∏ –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω–µ—Ç—É –∏–ª–∏ –ø–æ–∫–∞ –Ω–µ—Ç, —Ç–æ –ø—Ä–æ—Å—Ç–æ –≤–µ–∂–ª–∏–≤–æ –ø—Ä–µ–¥–ª–æ–∂–∏ –¥—Ä—É–≥–æ–µ —Å–æ–±—ã—Ç–∏–µ –∏–∑ –≤—ã—à–µ —Å–ø–∏—Å–∫–∞."
                    
                    f"–£ —Ç–µ–±—è –µ—Å—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–µ—Å—Ç–∞—Ö –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è—Ö: {get_all_categories_and_places()}.\n"
                    "–†–µ–∫–æ–º–µ–Ω–¥—É–π –∑–∞–≤–µ–¥–µ–Ω–∏—è –∏–∑ —ç—Ç–æ–≥–æ —Å–ø–∏—Å–∫–∞, –≤—Å–µ–≥–¥–∞ –ø–∏—à–∏ –∞–¥—Ä–µ—Å–∞ –≤ `` –¥–ª—è —Ä–∞–∑–º–µ—Ç–∫–∏, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å, –∏ —Å—Å—ã–ª–∫–∏ –Ω–∞ –∫–∞—Ä—Ç—É (–Ω–µ –∏–∑–º–µ–Ω—è–π –∏ –±–µ—Ä–∏ –∏—Ö —Ç–æ–ª—å–∫–æ –∏–∑ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –æ–Ω–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –±–æ–ª—å—à–∏–º–∏). "
                    "–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç –∏–º–µ–Ω–Ω–æ –∞–¥—Ä–µ—Å, —Ç–æ –∏—â–∏ –ø–æ –∞–¥—Ä–µ—Å—É –≤—Å–µ –º–µ—Å—Ç–∞ –∏ —Å–æ–±—ã—Ç–∏—è –∫–æ—Ç–æ—Ä—ã–µ —Ç–∞–º –º–æ–∂–Ω–æ –ø–æ—Å–µ—Ç–∏—Ç—å –∏–ª–∏ —Ä—è–¥–æ–º."
                    
                    "–û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–≤—É–º—è –º–µ—Å—Ç–∞–º–∏ –∏–ª–∏ —Å–æ–±—ã—Ç–∏—è–º–∏ –∑–∞ –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å. –ü–æ–¥—Ö–æ–¥–∏ –∫ —ç—Ç–æ–º—É —Ç–≤–æ—Ä—á–µ—Å–∫–∏ –∏ —ç–ª–µ–≥–∞–Ω—Ç–Ω–æ ‚ú®. "
                    "–°—Ç–∞—Ä–∞–π—Å—è –æ–ø–∏—Å—ã–≤–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∫—Ä–∞—Å–∏–≤–æ, –¥–æ–±–∞–≤–ª—è–π –∞—Ç–º–æ—Å—Ñ–µ—Ä—É –∏ —ç–º–æ—Ü–∏–∏. –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏, —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ –∂–∏–≤—ã–º –∏ –∑–∞–ø–æ–º–∏–Ω–∞—é—â–∏–º—Å—è üèôÔ∏èüé∂. "

                    "–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–∏—à–∏ –ø–æ-—Ä—É—Å—Å–∫–∏. –î–µ–ª–∞–π —ç—Ç–æ –≤–µ–∂–ª–∏–≤–æ –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ—â—É—â–∞–ª–∏ –∑–∞–±–æ—Ç—É –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–∏–∑–º."
                )}
            ]

        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞
        found_category = find_best_category(user_input)
        if found_category:
            # –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ –º–µ—Å—Ç–æ –∏–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            user_input = get_random_places_from_category(found_category, count=1) + \
                         "\n —ç—Ç–∏ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–∏–ª–∞ —Ç—ã - –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ –æ –Ω–∏—Ö –≤ –∫—Ä–∞—Å–∏–≤–æ–º –≤–∏–¥–µ —á–µ—Ä–µ–∑ –æ—Ç—Å—Ç—É–ø—ã. –ù–∞–ø–∏—à–∏ –æ–ø–∏—Å–∞–Ω–∏–µ –∏ –¥–æ–±–∞–≤—å —á—Ç–æ-—Ç–æ —Å–≤–æ–µ —Ç—É–¥–∞. –ù–µ –∑–∞–±—É–¥—å –æ—Å—Ç–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫–∏ –Ω–∞ –∫–∞—Ä—Ç—É —è–Ω–¥–µ–∫—Å–∞. –ù–µ –ø–∏—à–∏: –ö–æ–Ω–µ—á–Ω–æ! –í–æ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ü–∞—Ä–∫–µ –õ–µ–≤–æ–±–µ—Ä–µ–∂–Ω—ã–π –≤ –∫—Ä–∞—Å–∏–≤–æ–º –∏ —É—é—Ç–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ –∏ –≤ –ø–æ—Ö–æ–∂–µ–º —Ñ–æ—Ä–º–∞—Ç–µ"

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å
        conversation_history[user_name].append({"role": "user", "content": user_input})

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å –ø–æ–º–æ—â—å—é g4f
        stream = client.chat.completions.create(
            model="gpt-4o",
            messages=conversation_history[user_name],
            stream=True,
        )

        content = ""  # –î–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–ª–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
        async for chunk in stream:
            if chunk.choices and chunk.choices[0].delta.content:
                content += chunk.choices[0].delta.content

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
        conversation_history[user_name].append({"role": "assistant", "content": content})
        return content or "–ò–∑–≤–∏–Ω–∏—Ç–µ, —è –Ω–µ —Å–º–æ–≥ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤–∞—à –∑–∞–ø—Ä–æ—Å."
    except Exception as e:
        return f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}"
